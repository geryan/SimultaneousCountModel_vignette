---
title: "Simultaneous count model vignette"
output: html_notebook
---


## Packages
```{r packages}
library(dplyr)
library(rjags)
library(R2jags)
library(jagstools)
```
If necessary install `jagstools with:

`library(remotes)`

`remotes::install_github("johnbaums/jagstools")`


## Data
Create a dataset simulating population of 1000 individuals,

A survey effort at:
 - 5 sites,
 - visited 4 times/year,
 - for 5 years, where only,
 
Around half of the population is ever observed at each site in a single sampling occasion (visit), and

Probabilities of detection are constant at each site over time.
```{r dat}
dat <- array(
  data = rmultinom(
    n = 20,
    size = 1000, # population size
    c(0.01, 0.15, 0.04, 0.22, 0.08, 0.5) # site probabilities of detection (1:5), and probability of non-detection (6)
  ),
  dim = c(6,4,5), # sites +1, visits/year, years
  dimnames = list(
    site = sprintf("site%s", 1:6),
    "visit" = sprintf("visit%s", 1:4),
    "year" = sprintf("year%s", 1:5)
  )
)

dat
```

But we don't observe the population at "site6" because this represents the unobserved proportion of the population
```{r obsdat}
obsdat <- dat

obsdat[6,,] <- NA

obsdat
```

## Write model
JAGS model.
For explanation of ones trick see: https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/manual14.pdf
```{r jags.mod}
cat('
  data{
    for (j in 1:nvisits){
      for (k in 1:nyears){
        ones[j,k] <- 1
      }
    }
    C <- 10000
  }
  model{
#Priors for lambda and pi - alpha specified as vector of 1s
    lambda ~ dgamma(1e-5, 1e-5)#T(1,5000) # Lambda prior drawn from gamma distribution, truncated at 5000 to improve model convergence time
    
    N ~ dpois(lambda)
    
    pi[1:(nsites + 1)] ~ ddirich(alpha[1:(nsites + 1)])

    for (k in 1:nyears){
      for (j in 1:nvisits){
        
        seen[j,k] <- sum(obsdat[1:nsites,j,k]) # observations
        obsdat[nsites + 1,j,k] <- N - seen[j,k]
        
#Likelihood
        for (i in 1:nsites){
          lp[i,j,k] <- obsdat[i,j,k]*log(pi[i]) - logfact(obsdat[i,j,k]) #log product
        }
        lnL[j,k] <- sum(lp[1:nsites,j,k]) + logfact(N) #log likelihood
        log(P[j,k]) <- lnL[j,k] - log(C)
        ones[j,k] ~ dbern(P[j,k]) # ones trick
      }
    }
  }
  '
    , file = (jags.mod <- tempfile())) # This writes a temporary file with the model and assigns the path at jags.mod
```

## Prepare data
```{r jags.data}
nsites   <- dim(obsdat)[1] - 1 # should be 5
nvisits  <- dim(obsdat)[2]     # should be 4
nyears   <- dim(obsdat)[3]     # should be 5
  
alpha <- rep(1, (nsites + 1))
  
jags.params <- c("N", "pi", "lambda")

jags.inits <- function(){
  list(
    lambda = 5*sum(obsdat[,1,1], na.rm = TRUE) # initial value to search from is 5x the total observed in the first sampling occasion
  )
}

jags.data <- list(
  "obsdat",
  "nsites",
  "nvisits",
  "nyears",
  "alpha"
)


  
  assign("obsdat",     obsdat,     envir=globalenv())
  assign("alpha",      alpha,      envir=globalenv())
  assign("nsites",     nsites,     envir=globalenv())
  assign("nreps",      nreps,      envir=globalenv())
  assign("nyears",     nyears,     envir=globalenv())
  assign("jags.inits", jags.inits, envir=globalenv())
```

```{r}
jags.fit <- jags(
  data = jags.data,
  inits = jags.inits,
  parameters.to.save = jags.params,
  n.iter = 1000,
  n.burnin = 500,
  n.chains = 3,
  model.file = jags.mod
)
```

